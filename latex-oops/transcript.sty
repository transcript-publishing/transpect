%%
%% Pusblisher specific style sheet for transcript
%% To be used with le-tex cocotex.cls.
%%
%% Maintainer: marcus.hottenroth@le-tex.de
%%
%% lualatex  -  texlive ≥ 2019
%%
\NeedsTeXFormat{LaTeX2e}[2018/12/01]
\ProvidesPackage{transcript}[2021/04/09 transcript]\relax

% Übergangsvariable für TeXLive 2023.
\newif\if@TLtwenty \@TLtwentyfalse
\ifnum\luatexversion>111 \@TLtwentytrue\fi

% Paketoptionen
% Durchreichen der script-Optionen
\define@key{transcript.sty}{lay}[b]{\gdef\lay{lay=#1}\gdef\layout{#1}}
\DeclareOptionX{twocolumnContinuousChapters}{\global\let\@twocolumnContinuousChapters\relax}
\DeclareOptionX{noBlanksBeforeChapters}{\global\let\@noBlanksBeforeChapters\relax}
\define@key{transcript.sty}{captions}[top]{\gdef\ts@caps{#1}}
\define@key{transcript.sty}{captions_figure}[top]{\gdef\ts@caps@figure{#1}}
\define@key{transcript.sty}{captions_table}[top]{\gdef\ts@caps@table{#1}}
\define@key{transcript.sty}{journal_series}[]{\gdef\ts@journal@series{#1}}
\define@key{transcript.sty}{lay_type}[]{\gdef\ts@layout@type{#1}}
\DeclareOptionX{nonatbib}{\global\let\n@natbib\relax}

\gdef\ts@str@journal@abc{abc}
\gdef\ts@str@journal@aua{aua}
\gdef\ts@str@journal@jes{jes}
\gdef\ts@str@journal@zfa{zfa}
\gdef\ts@str@journal@zig{zig}
\gdef\ts@str@journal@zwg{zwg}

\gdef\ts@str@layout@mdw{mdw}
\gdef\ts@str@layout@std{std}
\gdef\ts@str@layout@xtx{xtx}

% Pfade sind nach Priorität geordnet und werden von TeX derart durchsucht.
% Dateiendungen können weggelassen werden und werden nach TeX-interner Prioritätenliste (\Gin@extensions) gewählt:
%     .pdf,.png,.jpg,.mps,.jpeg,.jbig2,.jb2,.PDF
\graphicspath{{logos/cc/}{logos/}{images/}{series/}}

% Alternative Schriften; zuschaltbar im Falle fehlender Zeichen in den Standardschriften.
\newif\if@altFonts \@altFontsfalse
\DeclareOptionX{altFonts}{\@altFontstrue}

\ProcessOptionsX\relax
\ifjournal\collectiontrue\fi

% Seitenzähler unter der Annahme, dass keine Titelei erzeugt wird.
% Das Titeleimodul setzt den Seitenzähler bei Aufruf auf 1.
\setcounter{page}{5}

% U. a. für linksbündige Motti auf der rechten Seitenhälfte bei Kapiteln verwendet.
\usepackage{ragged2e}

% Die Zeile auffüllende Punktierung. Verwendung derzeit für Inhalts- (transcript-headings.sty) sowie Tabellen- und Abbildungsverzeichnisse (transcript-floats.sty).
\def\tsDotfill{%
  \nobreak\leaders\hbox{%
    $\m@th
    \mkern \@dotsep mu\textnormal{\normalsize\hbox{.}}\mkern \@dotsep
    mu$%
  }%
  \hskip 1em plus 1fill% Mindestens 1 em horizontaler Platz, damit leere Auspunktierungen und Seitenzahlen direkt hinter der Überschrift im Inhaltsverzeichnis vermieden werden.
  \nobreak%
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Logische Operatoren für tpComps. %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newif\if@argA
\newif\if@argB

\long\def\tpIfCompAnd#1#2#3#4{%
  \@argAfalse
  \@argBfalse
  \expandafter\ifcsname tp@\tp@cur@cont @#1\endcsname
    \expandafter\ifx\csname tp@\tp@cur@cont @#1\endcsname\relax\else
      \@argAtrue
    \fi
  \fi
  \expandafter\ifcsname tp@\tp@cur@cont @#2\endcsname
    \expandafter\ifx\csname tp@\tp@cur@cont @#2\endcsname\relax\else
      \@argBtrue
    \fi
  \fi
  \if@argA
    \if@argB
      #3%
    \else
      #4%
    \fi
  \else
    #4%
  \fi%
}

\long\def\tpIfCompOr#1#2#3#4{%
  \@argAfalse
  \@argBfalse
  \expandafter\ifcsname tp@\tp@cur@cont @#1\endcsname
    \expandafter\ifx\csname tp@\tp@cur@cont @#1\endcsname\relax\else
      \@argAtrue
    \fi
  \fi
  \expandafter\ifcsname tp@\tp@cur@cont @#2\endcsname
    \expandafter\ifx\csname tp@\tp@cur@cont @#2\endcsname\relax\else
      \@argBtrue
    \fi
  \fi
  \if@argA
    {#3\relax}%
  \else
    \if@argB
      {#3\relax}%
    \else
      {#4\relax}%
    \fi
  \fi%
}

%%%%%%%%%%
% Fonts  %
%%%%%%%%%%
\usepackage{transcript-fonts}

\newdimen\tp@majuscleHeight

\def\circledNumber#1{\raisebox{.2pt}{\textcircled{\raisebox{-1.2pt}{\sffamily #1}}}}

\usepackage{newunicodechar}
%\newunicodechar{↩}{\ifmmode\hookleftarrow\else$\hookleftarrow$\fi}% 8617
\newunicodechar{‐}{\penalty\@M-\hskip\z@skip}% 8617, U+2010, ersetzt durch U+002D.
\newunicodechar{‑}{\hbox{-}\penalty\@M\hskip\z@skip}% 8617, U+2011 (non-breaking hyphen).
\newunicodechar{↩}{\hskip\z@skip}
\newunicodechar{。}{\hbox{$_\circ$\enskip\ignorespaces}}
\newunicodechar{、}{,\enskip\ignorespaces}
\newunicodechar{；}{;\enskip\ignorespaces}
\newunicodechar{：}{:\enskip\ignorespaces}
\newunicodechar{，}{,\enskip\ignorespaces}
\newunicodechar{ }{\,}
\newunicodechar{⌈}{$\lceil$}
\newunicodechar{⌉}{$\rceil$}
\newunicodechar{⌊}{$\lfloor$}
\newunicodechar{⌋}{$\rfloor$}
\newunicodechar{①}{\circledNumber{1}}
\newunicodechar{②}{\circledNumber{2}}
\newunicodechar{③}{\circledNumber{3}}
\newunicodechar{④}{\circledNumber{4}}
\newunicodechar{⑤}{\circledNumber{5}}
\newunicodechar{⑥}{\circledNumber{6}}
\newunicodechar{⑦}{\circledNumber{7}}
\newunicodechar{⑧}{\circledNumber{8}}
\newunicodechar{⑨}{\circledNumber{9}}
% Ideomatisches Komma für Chinesisch.
\newunicodechar{、}{\char"3001}
%\newunicodechar{ǀ}{|}

\newunicodechar{ǀ}{%
  \setbox\@tempboxa = \hbox{K}% Beliebige Versalie.
  \tp@majuscleHeight = \ht\@tempboxa%
  {\fontsize{\the\tp@majuscleHeight}{0bp}\selectfont\raisebox{\the\dimexpr0.24\tp@majuscleHeight\relax}{\unichar{ǀ}}}%
}
\newunicodechar{ǁ}{%
  \setbox\@tempboxa = \hbox{K}% Beliebige Versalie.
  \tp@majuscleHeight = \ht\@tempboxa%
  {\fontsize{\the\tp@majuscleHeight}{0bp}\selectfont\raisebox{\the\dimexpr0.24\tp@majuscleHeight\relax}{\unichar{ǁ}}}%
}
\newunicodechar{ǂ}{%
  \setbox\@tempboxa = \hbox{K}% Beliebige Versalie.
  \tp@majuscleHeight = \ht\@tempboxa%
  {\fontsize{\the\tp@majuscleHeight}{0bp}\selectfont\raisebox{\the\dimexpr0.24\tp@majuscleHeight\relax}{\unichar{ǂ}}}%
}
\newunicodechar{ǃ}{%
  \setbox\@tempboxa = \hbox{K}% Beliebige Versalie.
  \tp@majuscleHeight = \ht\@tempboxa%
  {\fontsize{\the\dimexpr1.4\tp@majuscleHeight\relax}{0bp}\selectfont\raisebox{\the\dimexpr0\tp@majuscleHeight\relax}{\unichar{ǃ}}}%
}

\DeclareRobustCommand\unichar[1]{\textfallback{#1}}


%%%%%%%%%%%%%%%%%%
% Schriftgrößen. %
%%%%%%%%%%%%%%%%%%

\usepackage{transcript-fontsizes}


%%%%%%%%%%%%%%%
% Papiermaße. %
%%%%%%%%%%%%%%%

\usepackage[\lay]{transcript-pagelayout}


%%%%%%%%%%%%%%%%%%%%%
% Seitengestaltung. %
%%%%%%%%%%%%%%%%%%%%%

\usepackage{transcript-pagestyles}

\gdef\cleardoublepage{%
  \clearpage
  \ifodd\c@page\relax\else
    \hbox{}\thispagestyle{empty}\newpage
    \if@twocolumn\hbox{}\thispagestyle{empty}\newpage\fi
  \fi}


%%%%%%%%%%%%%%%%%%
% Überschriften. %
%%%%%%%%%%%%%%%%%%

\usepackage{transcript-headings}


%%%%%%%%%%%%%%%%%%%%%%%
% Inhaltsverzeichnis. %
%%%%%%%%%%%%%%%%%%%%%%%

\usepackage{transcript-toc}


%%%%%%%%%%%%%%%%%%%%%%
% Fuß- und Endnoten. %
%%%%%%%%%%%%%%%%%%%%%%

\usepackage{transcript-notes}


%%%%%%%%%%%%%%%%%
% Gleitobjekte. %
%%%%%%%%%%%%%%%%%

\usepackage{transcript-floats}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Gestaltungselemente/Umgebungen. %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage{transcript-envs}


%%%%%%%%%%%%%%%%%%%%%%%%%
% Literaturverzeichnis. %
%%%%%%%%%%%%%%%%%%%%%%%%%

\ifx\n@natbib\relax\else
  \usepackage{transcript-bib}
\fi

\def\source#1{\leavevmode\par#1}


%%%%%%%%%%%%
% Titelei% %
%%%%%%%%%%%%

\usepackage{transcript-title}

\def\flq{‹}
\def\frq{›}


%%%%%%%%%%%%%
% Register. %
%%%%%%%%%%%%%

\usepackage{transcript-index}

\renewcommand\frontmatter{%
  \cleardoublepage
  \@frontmattertrue%
  \@mainmatterfalse%
  \@backmatterfalse%
  \pagenumbering{arabic}%
}

\renewcommand\mainmatter{%
  \cleardoublepage
  \@frontmatterfalse%
  \@mainmattertrue%
  \@backmatterfalse%
}

\newif\if@backmatter \@backmatterfalse
\renewcommand\backmatter{%
  \cleardoublepage
  \@frontmatterfalse%
  \@mainmatterfalse%
  \@backmattertrue%
  \pagestyle{backmatter}%
}

\def\tp@str@heading{heading}
\newunicodechar{…}{\ldots}



%%%%%%%%%%%%%
% Sprachen. %
%%%%%%%%%%%%%

% Erlaubt Umbruch nach jedem beliebigen Zeichen und fügt keinen Trennstrich ein.
\def\tp@letterwise#1{\@tp@letterwise#1{}}
\def\@tp@letterwise#1{\tp@firstChar{#1}\@@tp@letterwise}
\def\@@tp@letterwise#1{\ifx^#1^\else\tp@nextChar{#1}\expandafter\@@tp@letterwise\fi}
\def\tp@firstChar#1{#1}
\def\tp@nextChar#1{\allowbreak #1}


\gdef\tp@languageRules@arabic{%
  \rmfamily% Andere Schriften (bspw. \nsfwidefamily) verursachen einen Konvertierungsabbruch.
  \let\par\relax%
  \gdef\ldots{.\kern\fontdimen3\font.\kern\fontdimen3\font.\kern\fontdimen3\font}%
}

\gdef\tp@languageRules@french{%
  \NoAutoSpacing% Keine automatischen Leerzeichen, bspw. vor Satzschlusspunkten.
}


% Innerhalb einer Fußnote wird die globale Information, dass man sich in einer solchen befindet, gesetzt.
% Dies wird benötigt, damit in folgender Definition griechischer Text in Überschriften fett gesetzt werden kann, aber die Fettung nicht erscheint, wenn die Überschrift eine Fußnote besitzt, innerhalb derer wiederum ebenfalls griechischer Text vorkommt.
\let\@withinFootnote\@undefined
\preto\footnote{%
  \let\@withinFootnote\relax
}


\gdef\tp@languageRules@greek{%
  % Hier jeden Fall einzeln berücksichtigen, falls ein universeller Faktor keine Lösung darstellt.
  % BEGIN: Musterblock.
  %\bgroup
  %  \footnotesize
  %  \global\@tempdima=\f@size\p@
  %\egroup
  %\ifdim\f@size\p@=\@tempdima\relax
  %  \fontsize{6.8bp}{\the\baselineskip}\selectfont%
  %\fi
  %\bgroup
  %  \normalsize
  %  \global\@tempdima=\f@size\p@
  %\egroup
  %\ifdim\f@size\p@=\@tempdima\relax
  %  \fontsize{7.8bp}{\the\baselineskip}\selectfont%
  %\fi
  % END.
  \sffamily
  \ifx\@currenvir\tp@str@heading
    \ifx\@withinFootnote\relax
    \else
      \bfseries
    \fi
  \fi
  \fontsize{0.8468\dimexpr\f@size\p@\relax}{\the\baselineskip}\selectfont%
}

\gdef\tp@languageRules@chinese@macro#1{%
  \tp@letterwise{#1}%
}

\let\@foreignNewLanguageRules\foreignlanguage
\gdef\foreignlanguage#1#2{%
  \protect\@foreignNewLanguageRules{#1}{%
    \ifcsname tp@languageRules@\languagename\endcsname
      \csname tp@languageRules@\languagename\endcsname%
    \fi%
    \ifcsname tp@languageRules@\languagename @macro\endcsname
      \csname tp@languageRules@\languagename @macro\endcsname{#2}%
    \else
      #2%
    \fi
  }%
}

\let\@selectNewLanguageRules\selectlanguage
\gdef\selectlanguage#1{%
  \protect\@selectNewLanguageRules{#1}%
  \ifcsname tp@languageRules@\languagename\endcsname
    \csname tp@languageRules@\languagename\endcsname
  \fi
}%

\def\tpNewTocPage{\addtocontents{toc}{\protect\newpage}}

% Makro für verlinkte Bilder.
\let\imgHref\href

\def\@nohyphen#1#2\relax{#1\hskip0sp\@plus1sp\discretionary{}{}{}\if\relax#2\relax\else\@nohyphen#2\relax\relax\fi}
\protected\def\href#1#2{{\let↩\@empty\def\@tempa{\imgHref{#1}}\expandafter\@tempa\expandafter{\@nohyphen#2\relax\relax}}}
\let\fn@href\href
% \bgroup
% \let↩\relax
% \gdef\fn@href#1#2{\@fn@href #1\@nil #2↩↩\@nil}%
% \gdef\href#1#2{\@fn@href #1\@nil #2↩↩\@nil}%
% \gdef\@fn@href #1\@nil #2↩#3↩\@nil{\oldhref{#1}{#2}\hskip\z@skip\if!#3!\else\@fn@href #1\@nil #3↩\@nil\fi}
% \egroup
\usepackage[normalem]{ulem}
\let\ul\uline
\AtBeginDocument{%
  \ifx\tpRunBookTitle\@undefined
    \PackageError{transcript.sty}{No BookTitle given!}{}%
    \def\tpRunBookTitle{--~book title not defined~--}%
  \fi
}


\def\tpNoIndent{%
  \global\@noskipsectrue
  \everypar{%
    \if@noskipsec
      \global\@noskipsecfalse
      {\setbox\z@\lastbox}%
      \clubpenalty\@M
      \unskip
      \@tempskipa \parskip\relax
      \hskip -\@tempskipa
    \else
      \everypar{}%
    \fi%
  }%
}

\def\parbreak{%
  \par
  \vskip\baselineskip
  \tpNoIndent%
}


\endinput
