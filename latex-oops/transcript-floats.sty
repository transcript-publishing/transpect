\NeedsTeXFormat{LaTeX2e}[2018/12/01]
\ProvidesPackage{transcript-floats}[2021/04/09 transcript]\relax
\ProcessOptionsX\relax

% Gedrehte Gleitobjekte immer in die gleiche Richtung, nicht seitenabhängig (gerade vs. ungerade) drehen.
\@rot@twosidefalse
\def\rot@LR{-1}%
\usepackage{tabularx}
\usepackage{multirow}

\usepackage{htmltabs}
\expandafter\def\csname ht@font-family@sans-serif\endcsname{\ht@apply@prop{internal-font-family}{\nsffamily}}

% Standards für Tabellen:
\SetHTClass{}{%
  \SetClassProp{td}{font-family}{sans-serif}%
  \SetClassProp{td}{font-size}{x-small}%
  \SetClassProp[thead]{td}{font-weight}{bold}%
  \SetClassProp{td}{padding}{0.9mm 2.15mm 0.3mm}%
  \SetClassProp{table}{break-table}{true}%
  \SetClassProp{table}{hyphen}{auto}%
}

\intextsep\baselineskip

%% @marcush, das das vorher nicht richtig funktioniert hat, lag daran,
%% dass im coco-floats.sty die Hyperref-Anchor erzeugt wurden
%% *nachdem* die LoF/LoT-Einträge generiert wurden. Ich hab das
%% einfach umgedreht, damit kommen die Sprungziele und Seitenzahlen
%% korrekt raus. Ich hab daher deinen Mechanismus auskommentiert, da
%% er dafür gesorgt hat, dass die Einträge in der LoT um eins nach
%% hinten verschoben waren, also "Tabelle 2" hat die Seitenzahl von
%% "Tabelle 1" gekriegt und "Tabelle 1" hatte "0" als Seitenzahl; die
%% Sprungziele analog. (vgl. redmine-16842).
%
%
% % Ermittlung der echten Seitennummer durch Labels.
% \global\newcount\realpageCnt \global\realpageCnt=0
% \global\newcount\realpage
% \gdef\realHref{}
% \def\getLabelPage#1{%
%   \def\tp@getPage##1##2##3##4##5{##2}
%   \def\tp@getHref##1##2##3##4##5{##4}
%   \bgroup%
%     \def\@setref##1##2##3{%
%       \ifx##1\relax%
%         \@latex@warning{Reference `##3' on page \thepage \space undefined; ##1}%
%       \else
%         \global\realpage=\number\expandafter\tp@getPage##1
%         \xdef\realHref{\expandafter\tp@getHref##1}%
%       \fi
%     }
%     \pageref{#1}%
%   \egroup%
% }%

% \def\tp@str@table{table}
% \def\tp@flt@addcontentsline#1#2#3{%
%   % Ersetze \thepage durch \the\realpage.
%   \ifx#2\tp@str@table
%     \protected@write\@auxout{\tpGobble}{\string\@writefile{#1}{\protect\tpContentsline{#2}{#3}{\the\realpage}{\realHref}\protected@file@percent}}\relax
%   \else
%     \protected@write\@auxout{\tpGobble}{\string\@writefile{#1}{\protect\tpContentsline{#2}{#3}{\thepage}{\@currentHref}\protected@file@percent}}\relax
%   \fi
% }

% \def\tpGetTableContent{%
%   \ifx\htTableBox\@undefined\else
%     \ifvoid\htTableBox\else
%       % BEGIN: Setze die echte Seite auf den Tabellenanfang.
%       \phantomsection%
%       \label{floatLabel\the\realpageCnt}%
%       \getLabelPage{floatLabel\the\realpageCnt}%
%       \global\advance\realpageCnt\@ne%
%       % END.
%       \let\tp@floatbox\htTableBox%
%     \fi%
%   \fi%
% }

\def\tp@str@center{center}
%% gilt für Abbildungen und Tabellen (und weitere Floats) gleichermaßen:
\tpAddToDefault{float}{%
  \tpSetProperty{number-face}{}% Format of number, additional to caption-format
  \tpSetProperty{number-sep}{:\space\ignorespaces}
  \tpSetProperty{caption-sep-top}{3mm}%
  \tpSetProperty{caption-sep-bottom}{\dimexpr3mm\relax}%
  \tpSetProperty{subcaption-add-sep-top}{-2mm}%
  \tpSetProperty{caption-valign-top}{bottom}%
  \tpSetProperty{caption-valign-bottom}{top}%
  \tpSetProperty{caption-face-top}{\ifx\ts@layout@type\ts@str@layout@mdw\footnotesize\else\itshape\fi\RaggedRight}%
  \tpSetProperty{caption-face-bottom}{\footnotesize\upshape\RaggedRight}%
  \tpSetProperty{subfloat-sep}{2mm}%
  \tpSetProperty{intext-skip-top}{2\baselineskip}%
  \tpSetProperty{intext-skip-bottom}{\dimexpr2\baselineskip-2.5bp\relax}%
  \tpSetProperty{numbering}{}% keine automatische Nummerierung von Gleitobjekten!
  \ifcsname ts@caps@figure\endcsname%
  \else
    \let\ts@caps@figure\ts@caps%
  \fi
  \ifcsname ts@caps@table\endcsname%
  \else
    \let\ts@caps@table\ts@caps%
  \fi
  \ifcsname tp@captype\endcsname
    \expandafter\ifx\csname ts@caps@\tp@captype\endcsname\tp@str@bottom
      \tpSetProperty{caption-top}{}%
      \tpSetProperty{caption-bottom}{%
        \bgroup
          \normalsize\itshape%
          \tpIfComp{Number}{%
            {%
              \tpUseProperty{number-face}\tpUseComp{Number}%
              \tpIfComp{Caption}{%
                \tpUseProperty{number-sep}%
              }{%
                \par%
              }%
            }%
          }{}%
          \tpIfComp{Caption}{%
            \tpUseComp{Caption}\par%
          }{}%
          \tpIfComp{Legend}{%
            {\tpUseProperty{legend-format}\tpUseComp{Legend}}%
          }{}%
        \egroup
        \tpIfComp{Source}{%
          \tpIfComp{Legend}{%
            \par\nopagebreak%
          }{}%
          {\tpUseProperty{source-format}\tpUseComp{Source}}%
        }{}%
      }%
    \else
      \tpSetProperty{caption-bottom}{%
        \tpIfComp{Source}{%
          \tpIfComp{Legend}{%
            \par\nopagebreak%
          }{}%
          {\tpUseProperty{source-format}\tpUseComp{Source}}%
        }{}%
      }%
      \tpSetProperty{caption-top}{%
        \tpIfComp{Number}{%
          {%
            \tpUseProperty{number-face}\tpUseComp{Number}%
            \tpIfComp{Caption}{%
              \tpUseProperty{number-sep}%
            }{}%
          }%
        }{}%
        \tpIfComp{Caption}{%
          \tpUseComp{Caption}%
        }{}%
        \tpIfComp{Legend}{%
          {\tpUseProperty{legend-format}\tpUseComp{Legend}}%
        }{}%
      }%
    \fi
  \fi
  %% Parameter für Abbildungs- und Tabellenverzeichnisse.
  \tpSetProperty{list-of-caption-face}{\normalfont\normalsize\sffamily\if@TLtwenty\upseries\fi}% Mig2024
  \tpSetProperty{list-of-indent}{\z@}%
  \tpSetProperty{list-of-margin-left}{\z@}%
  \tpSetProperty{list-of-margin-right}{1.2em plus 1fil}%
  \tpSetProperty{list-of-page-sep}{\tsDotfill\kern.5\p@}% Definition für \tsDotfill in der Hauptdatei transcript.sty.
  \tpSetProperty{list-of-number-face}{}%
  \tpSetProperty{list-of-number-sep}{:\enskip}%
  \tpSetProperty{list-of-block}{%
    \tpUseProperty{list-of-caption-face}%
    \tpIfComp{ListofNumber}
      {\tpUseComp{ListofNumber}}
      {\leftskip0pt}%
    \tpUseComp{ListofCaption}%
    \tpUseProperty{list-of-page-sep}\tpUseComp{ListofPage}%
  }%
}

\setcounter{lofdepth}{0}%% Tiefe des Abb.-Verzeichnisses: 0 = nur Haupteinträge; 1 = auch (echte) sub-floats inkludieren!

%% gilt nur für Abbildungen:
\tpDeclareFloat{tpFigure}{figure}{lof}{%
  \tpSetProperty{intext-skip-bottom}{\dimexpr1\baselineskip-2.5bp\relax}% Ticket 14959, 14989.
  \ifx\ts@layout@type\ts@str@layout@mdw
    \tpSetProperty{number-face}{\bfseries}% Ticket 14957.
  \fi%
  \tpSetProperty{list-of-block}{%
    \tpUseProperty{list-of-caption-face}%
    \tpIfComp{ListofNumber}{%
      \@tempdima=\tpUseProperty{list-of-number-width-max}%
      \leftskip\@tempdima \hskip-\@tempdima
      \hbox to \@tempdima{%
        \tpUseComp{ListofNumber}%
        \tpIfComp{ListofCaption}{%
          \tpUseProperty{list-of-number-sep}%
        }{}%
        \hss%
      }%
      \tpIfComp{ListofCaption}{\ignorespaces\tpUseComp{ListofCaption}}{}%
    }{%
      \leftskip0pt \tpUseComp{ListofCaption}%
    }%
    \nobreak\tpUseProperty{list-of-page-sep}\tpTocLink{\tpUseComp{ListofPage}}%
  }%
}

%% gilt nur für Tabellen:
\tpDeclareFloat{tpTable}{table}{lot}{%
  \def\tpBreak{%
    \GetCellProp{@tempa}{text-align}%
    \def\@tempb{center}%
    \ifx\@tempa\@tempb
      \break
    \else
      \hfill\break
    \fi
  }
  \tpSetProperty{list-of-block}{%
    \tpUseProperty{list-of-caption-face}%
    \tpIfComp{ListofNumber}{%
      \@tempdima=\csname tp-tpTable-list-of-number-maxwd\endcsname%
      \leftskip\@tempdima\hskip-\@tempdima\hb@xt@\@tempdima{%
        \tpUseComp{ListofNumber}%
        \tpIfComp{ListofCaption}{%
          \tpUseProperty{list-of-number-sep}%
        }{}%
        \hss%
      }%
      \tpIfComp{ListofCaption}{\ignorespaces\tpUseComp{ListofCaption}}{}%
    }{%
      \leftskip0pt \tpUseComp{ListofCaption}%
    }%
    \nobreak\tpUseProperty{list-of-page-sep}\tpTocLink{\tpUseComp{ListofPage}}%
  }%
}


%% Klassen für Abbildungen:
\tpDeclareClass{A}{\tpSetProperty{margin-left}{0mm}\tpSetProperty{margin-right}{0mm}}
\tpDeclareClass{B}{\tpSetProperty{margin-left}{10mm}\tpSetProperty{margin-right}{10mm}}
\tpDeclareClass{C}{\tpSetProperty{margin-left}{15mm}\tpSetProperty{margin-right}{15mm}}
\tpDeclareClass{D}{\tpSetProperty{margin-left}{25mm}\tpSetProperty{margin-right}{25mm}}
\tpDeclareClass{E}{\tpSetProperty{margin-outer}{\dimexpr-\evensidemargin+10mm\relax}}

\tpDeclareClass{wide}{%
  \tpSetProperty{margin-outer}{\dimexpr-\evensidemargin+10mm\relax}%
  %\tpSetProperty{margin-inner}{-\oddsidemargin}%
}

\def\ht@min@p@rows{2}%
\def\ht@min@b@rows{2}%


%% Abbildungsverzeichnis
\renewcommand\listoffigures{%
  \@starttoc{lof}%
  \clearpage%
}

%% Tabellenverzeichnis
\renewcommand\listoftables{%
  \@starttoc{lot}%
  \clearpage%
}
