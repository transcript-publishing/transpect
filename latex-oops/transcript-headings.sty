\NeedsTeXFormat{LaTeX2e}[2018/12/01]
\ProvidesPackage{transcript-headings}[2021/08/18 transcript]\relax

% Umschalter für alternative Kolumnentitel (Ticket 16094).
\newif\if@altRunTitles \@altRunTitlesfalse
\def\altRunTitles{%
  \@altRunTitlestrue%
  \pagestyle{altRunTitles}%
}


%% Globale Settings: gelten für alle ÜS-Ebenen
\tpAddToDefault{heading}{%
  \tpSetProperty{numbering}{}%
  \tpSetProperty{margin-left}{}% leer um Default "auto" zu überschreiben
  \tpSetProperty{indent}{auto}%
  \tpSetProperty{toc-margin-right}{6em}%
  \ifcollection
    \tpSetProperty{toc-margin-left}{}%
    \tpSetProperty{toc-indent}{}%
  \else
    \tpSetProperty{toc-margin-left}{\tpIfComp{TocNumber}{auto}{0mm}}%
    \tpSetProperty{toc-indent}{auto}%
  \fi
  \tpSetProperty{toc-number-align}{left}%
  \tpSetProperty{toc-number-sep}{\enskip}%
  \tpSetProperty{toc-page-sep}{\tsDotfill}% Definition für \tsDotfill in der Hauptdatei transcript.sty.
  \tpSetProperty{toc-title-face}{\sffamily\normalsize}%
  \tpSetProperty{toc-page-face}{\normalfont\sfwidefamily\normalsize}%
  \tpSetProperty{toc-format}{%
    \tpUseProperty{toc-title-face}%
    \tpIfComp{TocAuthorNameList}{\tpTocLink{\tpUseComp{TocAuthorNameList}:}\newline}{}%
    \tpIfComp{TocNumber}{\tpUseProperty{toc-hang-number}}{}%
    \tpTocLink{%
      \tpUseComp{TocTitle}%
      \tpIfComp{TocSubtitle}{%
        \hfill\break%
        \tpUseComp{TocSubtitle}%
      }{}%
      \tpUseProperty{toc-page-sep}\tpUseComp{TocPage}}%
  }%
  \tpSetProperty{running-heading}{}%
  \tpSetProperty{running-extra}{}%
}

\gdef\tp@currentHeading{}

\tpDeclareHeading{-1}{part}{%
  %% ToC
  %\tpSetProperty{toc-before-hook-part}{\nobreak}
  \tpSetProperty{toc-after-hook-part}{\nopagebreak}
  \tpSetProperty{toc-margin-top}{2.25em}%
  \tpSetProperty{toc-indent}{}%
  \tpSetProperty{toc-title-face}{\sffamily\sbseries\ifx\ts@layout@type\ts@str@layout@mdw\LARGE\else\huge\fi}%
  
  \tpSetProperty{toc-before-entry}{%
    \addvspace{\tpUseProperty{toc-margin-top}}
    \parindent \z@
    \hyphenpenalty=\@M
    \let\\\@centercr
    \rightskip\z@skip\relax
    \parfillskip\@flushglue
  }%
  
  \tpSetProperty{toc-format}{%
    \tpUseProperty{toc-title-face}%
    \tpIfComp{TocNumber}{%
      \ifcsname tp-heading-toc-number--1-maxwd\endcsname
        \@tempdima=\csname tp-heading-toc-number--1-maxwd\endcsname%
      \else
        \@tempdima=\z@%
      \fi%
      \leftskip\@tempdima\hskip-\@tempdima\hbox to \@tempdima{\tpTocLink{\tpUseComp{TocNumber}\tpUseProperty{toc-number-sep}}\hss}%
    }{%
      \leftskip\z@%
    }%    
    \tpTocLink{\tpUseComp{TocTitle}}%
  }%
  
  \tpSetProperty{toc-after-entry}{\nopagebreak\par\nopagebreak\addvspace{\tpUseProperty{toc-margin-bottom}}\nopagebreak}% Thing at the end of the entry, after the page number

  
  \tpSetProperty{margin-left}{}% leer um Default "auto" zu überschreiben
  \tpSetProperty{indent}{}% leer um Default "auto" zu überschreiben
  \tpSetProperty{title-face}{%
    \sffamily\sbseries%
    \ifx\ts@layout@type\ts@str@layout@mdw
      \Huge%
    \else%
      \HUGE%
    \fi%
    \selectfont%
  }%
  \tpSetProperty{quote-block-format}{%
    \hfill\hbox{%
      \vbox{%
        \rightskip\z@
        \hsize.5\textwidth
        \normalfont\normalsize%
        \ifx\ts@layout@type\ts@str@layout@mdw
          \rmfamily%
        \else
          \nsfwiderfamily%
        \fi
        \@tempdima=\baselineskip% Ticket 15122.
        \baselineskip=\dimexpr0.92\@tempdima\relax% Ticket 15122.
        \tpUseComp{QuoteText}\par
        %% Zitat-Quelle
        \tpIfComp{QuoteSource}{%
          {\itshape\tpUseComp{QuoteSource}\par}%
        }{}%
      }%
    }%
  }
  
  \tpSetProperty{before-heading}{%
    \cleardoublepage
    \null\vskip\headingsep
    \thispagestyle{empty}%
    %\global\let\@chaptermark\@undefined
    \global\let\has@parts\relax
    \immediate\write\@auxout{\string\global\string\let\string\has@parts\string\relax}%
    % Zurücksetzen der Fußnotenzählen bereits bei Parts, nicht erst bei Chapter. Ticket 15665.
    \global\c@footnote\z@
  }%
  
  \tpSetProperty{running-heading}{%
    \ifx\tp@partnumber\relax
    \else
      \tp@partnumber\space%
    \fi%
    \tp@partmark%
  }
  
  \tpSetProperty{heading-block}{%
    \gdef\tp@currentHeading{chapter}%
    % Kolumnentitel setzen.
    \ifcollection
      \ifjournal
        \tpIfComp{RunTitle}{%
          \tpGStoreComp\tp@partmark{RunTitle}%
        }{%
          \tpIfComp{Title}{%
            \tpGStoreComp\tp@partmark{Title}%
          }{}%
        }
      \else
        \global\let\tp@authormark\relax%
        \global\let\tp@partmark\undefined% Nutzt dann den Buchtitel als Fallback.
        \tpIfComp{RunTitle}{%
          \tpGStoreComp\tp@chaptermark{RunTitle}%
          \tpGStoreComp\tp@latestPartmark{RunTitle}%
        }{%
          \tpGStoreComp\tp@chaptermark{Title}%
          \tpGStoreComp\tp@latestPartmark{Title}%
        }%
      \fi
    \else
      \tpIfComp{RunTitle}{%
        \tpGStoreComp\tp@chaptermark{RunTitle}%
      }{
        \tpGStoreComp\tp@chaptermark{Title}%
      }%
      \tpIfComp{RunNumber}{%
        \tpGStoreComp\tp@chapternumber{RunNumber}%
      }{
        \tpIfComp{Number}{%
          \tpGStoreComp\tp@chapternumber{Number}%
        }{%
          \global\let\tp@chapternumber\relax%
        }%
      }%
    \fi
    \tpUseProperty{title-face}%
    %\vskip.5\baselineskip
    \tpIfComp{Number}{\tpUseComp{Number}\enskip}{}%
    \tpUseComp{Title}\par%
    \tpIfComp{Subtitle}{\@@par\vskip\baselineskip\large\bfseries\tpUseComp{Subtitle}\leavevmode\vskip\baselineskip}{}%
    %% Zitat
    \tpIfComp{QuoteBlock}{%
      \vskip2\baselineskip
      \savenotes
      \tpUseComp{QuoteBlock}
      \spewnotes
      %\vskip-2\baselineskip
      \vskip\baselineskip% LUP: 2023-10-19, #15665
    }{}%
  }%
  \tpSetProperty{after-heading-block}{\vfill}%
}


\gdef\tp@runningHeadingLeft@backmatter{\relax}
\gdef\tp@runningHeadingRight@backmatter{\relax}

\gdef\tp@chaptermark{UNKNOWN CHAPTERMARK}
\global\let\tp@latestPartmark\relax% latestPartmark wird im part gespeichert und in Anthologien bei chapter als partmark gesetzt.
\global\let\tp@authormark\relax

\tpAddToHook[heading]{before-print-hook-chapter}{%
  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  % Wird zu zeitig ausgewertet. RunAuthorNameList landet auf der Seite vor dem Kapitel, zu dem der Autorennamen eigentlich gehört. %
  % Zurück zum vorherigen Zustand (\global\let\tp@authormark\relax).                                                               %
  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  %\ifcollection
  %  \global\let\tp@authormark\@empty
  %\fi
  %\tpIfComp{RunAuthorNameList}{%
  %  \tpGStoreComp\tp@authormark{RunAuthorNameList}%
  %}{%
  %  \tpIfCompOverride{AuthorNameList}{%
  %    \tpGStoreComp\tp@authormark{AuthorNameList}%
  %  }{%
  %    \tpCompGDef\tp@authormark{tpAuthor}{author-list-print-format}%
  %  }%
  %}%
}


%%%%%%%%%%%%
% Chapter. %
%%%%%%%%%%%%

\tpDeclareHeading{0}{chapter}{%
  % Ticket 13717.
  \if@backmatter%
    \tpSetProperty{bookmark-level}{-1}
  \fi
  
  %% Format IHV-Eintrag
  \tpSetProperty{toc-margin-top}{1\baselineskip}%
  \tpSetProperty{toc-margin-right}{2em}% Begrenzt die Breite, auf der Titel und Untertitel erscheinen können. 2 em sind dann der Platz, auf dem die Seitenzahl »übersteht«.
  \tpSetProperty{toc-number-sep}{\enskip}%
  \tpSetProperty{toc-title-face}{\sbseries\sfchapwidefamily\normalsize}%
  \tpSetProperty{toc-subtitle-face}{\normalfont\sfchapsubtocfamily\normalsize\if@TLtwenty\upseries\fi}%
  \tpSetProperty{toc-author-face}{\normalfont\normalsize\sfchapfamily\itshape\if@TLtwenty\upseries\fi}%
  \tpSetProperty{toc-page-face}{\normalfont\normalsize\sfchapwidefamily\if@TLtwenty\upseries\fi}%
  \tpSetProperty{toc-indent}{0em}%
  \tpSetProperty{toc-margin-left}{0em}%
  \tpSetProperty{toc-format}{%
    %\ifdim\dimexpr\pagegoal-\pagetotal\relax<7\baselineskip\relax
    %  \clearpage%
    %\fi
    % VBox verhindert durch Seitenumbruch auseinandergerissene Überschriften im Inhaltsverzeichnis.
    \vtop{\strut%
      \tpUseProperty{toc-title-face}%
      \tpIfComp{TocNumber}{%
        \@tempdima=\csname tp-heading-toc-number-0-maxwd\endcsname%
        \@tempdimb=0\p@\relax
        \expandafter\ifx\csname tp-heading-toc-number-1-maxwd\endcsname\relax%
        \else%
          \@tempdimb=\csname tp-heading-toc-number-1-maxwd\endcsname\relax%
        \fi%
        \ifdim\@tempdima<\@tempdimb\relax%
          \@tempdima=\@tempdimb%
        \fi%
        \leftskip\@tempdima\hskip-\@tempdima\hbox to \@tempdima{\tpTocLink{\tpUseComp{TocNumber}}\hss}%
      }{%
        \leftskip\z@%
      }%
      \strut\tpTocLink{\tpUseComp{TocTitle}}%
      \tpIfComp{TocSubtitle}{\nopagebreak\newline{\tpUseProperty{toc-subtitle-face}\tpTocLink{\tpUseComp{TocSubtitle}}}}{}%
      \tpIfComp{TocAuthorNameList}{\nopagebreak\newline{\tpUseProperty{toc-author-face}\tpTocLink{\tpUseComp{TocAuthorNameList}}}}{}%
      \tpUseProperty{toc-page-face}\tpTocLink{\tpUseProperty{toc-page-sep}\tpUseComp{TocPage}}%
      \strut%
    }
  }%
  
  % Unter Umständen nur für Monographien sinnvoll. In jenem Fall dann entsprechend anpassen.
  \tpSetProperty{toc-after-entry}{%
    \ifcollection
    \else
      \ifnum\c@tocdepth>0
        \nopagebreak%
      \fi%
    \fi%
  }%
  
  %% Format PDF-Bookmarks
  \tpSetProperty{bookmark}{%
    % \tpIfComp{TocAuthor}{\tpUseComp{TocAuthor}:\space}{}%
    \tpIfComp{BMNumber}{%
      \tpUseComp{BMNumber}\space%
    }{}%
    \tpUseComp{BMTitle}%
  }

  \tpSetProperty{title-face}{\ifx\ts@layout@type\ts@str@layout@mdw\huge\else\Huge\fi\sbseries\sfchapfamily}%
  \tpSetProperty{subtitle-face}{\normalfont\fontsize{13.7bp}{17.2bp}\selectfont\sfchapsubfamily\upseries}
  
  \tpSetProperty{quote-block-format}{%
    \parskip\baselineskip
    \rightskip\z@
    % BEGIN: Modifiziertes \RaggedRight (\raggedright mit Silbentrennung).
    \leftskip0.5\textwidth
    \@rightskip\RaggedRightRightskip
    \rightskip\@rightskip
    % END.
    \normalfont
    \normalsize
    \ifx\ts@layout@type\ts@str@layout@mdw
      \rmfamily%
    \else
      \nsfwiderfamily%
    \fi
    \@tempdima=\baselineskip% Ticket 15122.
    \baselineskip=\dimexpr0.92\@tempdima\relax% Ticket 15122.
    \tpUseComp{QuoteText}%
    \tpIfComp{QuoteSource}{%
      {\hfill\break\itshape\tpUseComp{QuoteSource}}\par%
    }{%
      \par%
    }%
  }
  
  \tpSetProperty{before-heading}{\cleardoublepage\if@twocolumn\else\null\nobreak\vskip\dimexpr\headingsep-.45mm\relax\fi}%
  
  \tpSetProperty{running-heading}{%
    \tp@chaptermark%
  }{}
  
  \tpSetProperty{heading-block}{%
    \gdef\tp@currentHeading{chapter}
    \ifcollection
      \ifx\tp@latestPartmark\relax\else
        \protected@xdef\tp@partmark{\tp@latestPartmark}%
      \fi
    \fi
    \tpIfComp{RunNumber}{%
      \tpGStoreComp\tp@chapternumber{RunNumber}%
    }{
      \tpIfComp{Number}{%
        \tpGStoreComp\tp@chapternumber{Number}%
      }{%
        \global\let\tp@chapternumber\relax%
      }
    }%
    \tpIfComp{RunTitle}{%
      \tpGStoreComp\tp@chaptermark{RunTitle}%
    }{%
      \tpGStoreComp\tp@chaptermark{Title}%
    }%
    \tpIfComp{RunAuthorNameList}{%
      \tpGStoreComp\tp@authormark{RunAuthorNameList}%
    }{%
      \tpIfCompOverride{AuthorNameList}{%
        \tpGStoreComp\tp@authormark{AuthorNameList}%
      }{%
        \tpCompGDef\tp@authormark{tpAuthor}{author-list-print-format}%
      }%
    }%
    \ifx\ts@journal@series\ts@str@journal@zig
      \protected@xdef\tp@partmark{\tp@authormark}%
    \fi
    %% Titel
    \ifjournal
    \else
      \thispagestyle{empty}
    \fi
    \leftskip\z@
    \leavevmode
    \bgroup
      \raggedright
      \tpIfComp{Number}{\leftskip-\tpUseProperty{indent}}{}%
      \tpUseProperty{title-face}%
      {%
        \tpIfComp{Number}{\tpUseProperty{hang-number}}{}%
        \tpUseComp{Title}%
      }%
      \tpIfComp{Subtitle}{%
        \par\vskip1.1bp%
        \tpUseProperty{subtitle-face}%
        \tpUseComp{Subtitle}%
      }{}%
      \par\nobreak
    \egroup
    %% Linie
    \vskip\dimexpr-1\baselineskip\relax
    \smash{\rlap{\lower3.25mm\vbox{\rule{\hsize}{.4\p@}}}}\par%
    %% Autor
    \tpIfComp{AuthorNameList}{%
      \vskip\baselineskip
      {\large\sfwidefamily\upseries\itshape\tpUseComp{AuthorNameList}}%
      \par%\vskip\baselineskip
    }{}%
    %% Zitat
    \par
    \tpIfComp{QuoteBlock}{%
      \vskip1\baselineskip
      \savenotes
      \tpUseComp{QuoteBlock}\par%
      \tpIfComp{AuthorNameList}{%
        \vskip\dimexpr-1.68\baselineskip+2\baselineskip\relax%
      }{%
        \vskip-1.68\baselineskip%
      }%
      \spewnotes
    }{}%
  }%
  
  \tpSetProperty{after-skip}{\tpIfComp{AuthorNameList}{1.68\baselineskip}{3.68\baselineskip}}
}


% Für Zeitschriften.
\global\newcount\@currAffilCnt \global\@currAffilCnt=1
\global\newbox\@articlefooterbox%


%%%%%%%%%%%%%%%%%
% Contribution. %
%%%%%%%%%%%%%%%%%

\tpDeclareHeading[chapter]{0}{contribution}{%
  \tpSetProperty{extended}{true}% stellt weitere Makros bereit wie \tpAbstract, \tpKeywords etc.
  \global\let\tpAbstractTitle\tpAbstractLabel
  \global\let\tpKeywordsTitle\tpKeywordsLabel
  \global\let\tpTitleEnTitle\tpTitleEnLabel
  %\thispagestyle{articlehead}
  
  % Artikel-DOI für die Zeitschriftenauftaktseite. Aus den Makros der Überschrift übernommen.
  % Muss global und ausgewertet sein, damit das Seitenlayout ps@articlehead darauf zugreifen kann.
  \xdef\@articleDOI{\tpUseComp{DOI}}%
  
  % Vorherblock, 15194.
  \tpSetProperty{affiliation-format}{}%
  \tpSetProperty{affil-block-format}{\tpUseComp{Affiliation}}
  \tpSetProperty{affil-block-face}{\footnotesize\nsffamily}
  \tpSetProperty{author-contact-format}{%
    \ifx\ts@journal@series\ts@str@journal@zig
      \tpIfComp{AffilRef}{%
        \tpUseComp{FullName} (\tpUseGroupProp{tpAffil}{\tpUseComp{AffilRef}}{affil-block-format})%
      }{%
        \tpUseComp{FullName}%
        \tpIfComp{Affiliation}{%
          \space(\tpUseComp{Affiliation})%
        }{}%
      }%
    \else
      \tpIfComp{AffilRef}{%
        \tpUseComp{FullName} (\tpUseGroupProp{tpAffil}{\tpUseComp{AffilRef}}{affil-block-format});\par%
        \tpIfComp{Email}{\tpUseComp{Email};\par}{}%
        \tpIfComp{ORCID}{\tpUseComp{ORCID};\par}{}%
      }{%
        \tpUseComp{FullName}%
        \tpIfComp{Affiliation}{%
          \space(\tpUseComp{Affiliation})%
        }{}%
        ;\par
        \tpIfComp{Email}{\tpUseComp{Email};\par}{}%
        \tpIfComp{ORCID}{\tpUseComp{ORCID};\par}{}%
      }%
    \fi
  }

  \tpSetProperty{counted-name-sep}{/}

  \tpSetProperty{before-heading}{%
    \cleardoublepage%
    \if@twocolumn% Kein vspace vor Überschriften zweispaltiger Kapitel.
    \else%
      \null\nobreak\vskip\dimexpr\headingsep-.45mm\relax%
    \fi
    \thispagestyle{articlehead}
    % Lizenzlogo und -text für die Ausgabe in der Fußzeile je Artikel speichern.
    %\global\setbox\@licenceTextFooter = \hbox{}
    
    \xdef\@headingDOI{\tpUseComp{DOI}}
    \def\@headingCopyright{%
      \tpIfComp{LicenceLogo}{%
        \includegraphics[height=7bp]{\tpUseComp{LicenceLogo}}\space%
        \footnotesize\nsffamily%
        \tpUseComp{LicenceName}\space%
      }{}%
      \tpUseComp{Copyright}%
    }
    \tpIfComp{LicenceLogo}{%
      \xdef\@articleLicenceLogo{\tpUseComp{LicenceLogo}}%
    }{
      \global\let\@articleLicenceLogo\relax%
    }
    
    \global\setbox\@articlefooterbox = \vbox{%
      \parindent\z@%
      \tpUseProperty{affil-block-face}%
      \ifx\ts@journal@series\ts@str@journal@zig
        %
        % Ausgabe der Autoren mit Instituts-/Unternehmenszugehörigkeit.
        \tpSetProperty{author-contact-format}{%
          \tpIfComp{AffilRef}{%
            \tpUseComp{FullName} (\tpUseGroupProp{tpAffil}{\tpUseComp{AffilRef}}{affil-block-format})%
          }{%
            \tpUseComp{FullName}%
            \tpIfComp{Affiliation}{%
              \space(\tpUseComp{Affiliation})%
            }{}%
          }%
        }%
        \tpSetProperty{counted-name-sep}{;\space}
        \tpUseComp{AuthorContactBlock}\par
        %
        % Ausgabe der E-Mail-Adressen der Autoren.
        \tpSetProperty{author-contact-format}{%
          \tpIfComp{Email}{\tpUseComp{Email}}{}%
        }%
        \tpUseComp{AuthorContactBlock}\par%
        %
        % Ausgabe der ORCIDs der Autoren.
        \tpSetProperty{author-contact-format}{%
          \tpIfComp{ORCID}{\tpUseComp{ORCID}}{}%
        }%
        \tpUseComp{AuthorContactBlock}\par
      \else
        \tpUseComp{AuthorContactBlock}\par
      \fi
      \tpIfComp{LicenceLogo}{%
        \ifnum\tpAuthorCnt>\z@%
          \includegraphics[height=7bp]{\tpUseComp{LicenceLogo}}\space%
        \fi
        \footnotesize\nsffamily%
        \tpUseComp{LicenceName}\space%
      }{}%
      \tpUseComp{Copyright}%
      \global\advance\@currAffilCnt\@ne%
    }
    \@tempdima = \the\ht\@articlefooterbox
    % Verkleinere die Seite um die Höhe der Fußzeileninformationen.
    \enlargethispage{-\@tempdima}
    %\tpIfComp{AffilBlock}{{\tpUseProperty{affil-block-face}\tpUseComp{AffilBlock}}\par}{}
  }

  \tpSetProperty{extended-heading}{%
    \tpIfComp{Abstract}{%
      \par\vskip2\baselineskip
        \rightskip\z@
        {\mdseries\sffamily\tpIfComp{AbstractLabel}{\tpUseComp{AbstractLabel}}{Abstract}}\enskip
        {\itshape\tpUseComp{Abstract}}\par%
      }
      {}%
    \tpIfComp{TitleEn}{%
      \par\vskip\baselineskip
      {\mdseries\sffamily\tpIfComp{TitleEnLabel}{\tpUseComp{TitleEnLabel}}{Title}}\enskip
      {\itshape\tpUseComp{TitleEn}\par}%
    }{}
    \tpIfComp{Keywords}{%
      \par\vskip\baselineskip
      {\mdseries\sffamily\tpIfComp{KeywordsLabel}{\tpUseComp{KeywordsLabel}}{Keywords}}\enskip
      {\itshape\tpUseComp{Keywords}\par}%
    }{}%
    \goodbreak%
  }%
}

\def\tp@make@run{%
  \tp@check@empty{heading}{Title}{Run}%
  \tp@check@empty{heading}{Number}{Run}%
  \cch@set@author@name@list{Run}%
  \tp@check@empty{heading}{Subtitle}{Run}%
  \tpUseProperty{running-extra}%
}


%%%%%%%%%%%
% Review. %
%%%%%%%%%%%

\tpDeclareHeading[chapter]{0}{review}{%
  % IHV-Überschrift der Rezension unterscheidet sich von chapter darin, dass kein Untertitel ausgegeben wird.
  \tpSetProperty{toc-format}{%
    \vtop{\strut%
      \tpUseProperty{toc-title-face}%
      \tpIfComp{TocNumber}{%
        \@tempdima=\csname tp-heading-toc-number-0-maxwd\endcsname%
        \@tempdimb=0\p@\relax
        \expandafter\ifx\csname tp-heading-toc-number-1-maxwd\endcsname\relax%
        \else%
          \@tempdimb=\csname tp-heading-toc-number-1-maxwd\endcsname\relax%
        \fi%
        \ifdim\@tempdima<\@tempdimb\relax%
          \@tempdima=\@tempdimb%
        \fi%
        \leftskip\@tempdima\hskip-\@tempdima\hbox to \@tempdima{\tpTocLink{\tpUseComp{TocNumber}}\hss}%
      }{%
        \leftskip\z@%
      }%
      \strut\tpTocLink{\tpUseComp{TocTitle}}%
      %\tpIfComp{TocSubtitle}{\nopagebreak\newline{\tpUseProperty{toc-subtitle-format}\tpTocLink{\tpUseComp{TocSubtitle}}}}{}%
      \tpIfComp{TocAuthorNameList}{\nopagebreak\newline{\normalfont\sfchapfamily\itshape\normalsize\tpTocLink{\tpUseComp{TocAuthorNameList}}}}{}%
      \tpUseProperty{toc-number-face}\tpTocLink{\tpUseProperty{toc-page-sep}\tpUseComp{TocPage}}%
      \strut%
    }
  }%

  \tpSetProperty{title-face}{\sffamily\ifx\ts@layout@type\ts@str@layout@mdw\Large\bfseries\else\LARGE\sbseries\fi}%
  \tpSetProperty{subtitle-face}{\normalfont\rmfamily\normalsize}%

  \tpSetProperty{before-heading}{\addvspace{24.2bp}}%


  \tpSetProperty{running-extra}{%
    \global\let\tp@partmark\relax%
    \global\let\tp@chapternumber\relax%
    \global\let\tp@authormark\relax
    \tpIfComp{RunTitle}{%
      \tpGStoreComp\tp@chaptermark{RunTitle}%
    }{
      \tpGStoreComp\tp@chaptermark{Title}%
    }%
    \ifx\ts@journal@series\ts@str@journal@zig
      \tpIfComp{RunAuthorNameList}{%
        \tpGStoreComp\tp@authormark{RunAuthorNameList}%
      }{%
        \tpIfCompOverride{AuthorNameList}{%
          \tpGStoreComp\tp@authormark{AuthorNameList}%
        }{%
          \tpCompGDef\tp@authormark{tpAuthor}{author-list-print-format}%
        }%
      }%
    \fi
  }
  
  \tpSetProperty{heading-block}{%
    \clearpage
    \thispagestyle{empty}
    \gdef\tp@currentHeading{chapter}%
    \savenotes
    \bgroup
      \if@twocolumn
        \begin{table*}[t]%
      \fi
        \normalfont
        \interlinepenalty\@M
        \tpUseProperty{title-face}%
        \tpIfComp{Number}{\tpUseProperty{hang-number}}{\leftskip\z@}%
        \tpUseComp{Title}\par\nopagebreak%
        \tpIfComp{Subtitle}{\tpUseComp{subtitle-face}\tpUseComp{Subtitle}\nopagebreak\par}{}%\addvspace{12.8bp}\nopagebreak}{}% Ticket 14677.
        \tpIfComp{DOI}{%
          \vskip\baselineskip%
          \tpUseComp{DOI}%
        }{}%
      \if@twocolumn
        \vspace{1\baselineskip}%
        \end{table*}%
      \fi%
    \egroup
    \nopagebreak
    \spewnotes
  }%
  
  \tpSetProperty{after-heading-block}{\nopagebreak}
  \tpSetProperty{after-skip}{3\baselineskip}%
}


%%%%%%%%%%%%
% Section. %
%%%%%%%%%%%%

\tpDeclareHeading{1}{section}{%
  % Ticket 13717.
  \if@backmatter%
    \tpSetProperty{bookmark-level}{-1}
  \fi
  
  \ifcollection
    \tpSetProperty{toc-indent}{0em}%
    \tpSetProperty{toc-margin-left}{0em}%
    \tpSetProperty{toc-before-entry}{\nopagebreak}%
    \tpSetProperty{toc-subtitle-face}{\normalfont\normalsize}%
    \tpSetProperty{toc-format}{%
      \tpUseProperty{toc-title-face}%
      \tpIfComp{TocNumber}{%
        \tpIfComp{TocAuthorNameList}{\tpTocLink{\tpUseComp{TocAuthorNameList}:}\newline}{}%
        \@tempdima=\csname tp-heading-toc-number-1-maxwd\endcsname\relax%
        \@tempdimb=\csname tp-heading-toc-number-0-maxwd\endcsname\relax%
        \ifdim\@tempdima<\@tempdimb\relax
          \@tempdima=\@tempdimb%
        \fi%
        \leftskip\@tempdima\hskip-\@tempdima\hbox to \@tempdima{\tpTocLink{\tpUseComp{TocNumber}}\hss}%
      }{%\leftskip\z@%
        \tpIfComp{TocAuthorNameList}{\tpTocLink{\tpUseComp{TocAuthorNameList}:}\space}{}%
      }%
      \noindent%
      \advance\leftskip by 2em%
      \setbox\@tempboxa=\hbox{\tpUseComp{TocPage}}%
      \rightskip\wd\@tempboxa%
      \tpTocLink{\tpUseComp{TocTitle}}%
      \tpIfComp{TocSubtitle}{%
        \newline%
        {\tpUseProperty{toc-subtitle-face}\tpTocLink{\tpUseComp{TocSubtitle}}}%
      }{}%
      \tpTocLink{\tpUseProperty{toc-page-sep}\rlap{\hb@xt@\wd\@tempboxa{\tpUseComp{TocPage}}}}%
    }%
  \else
    \tpSetProperty{toc-before-entry}{%
      \addvspace{\tpUseProperty{toc-margin-top}}
      \parindent \z@
      \raggedright
    }%
    \tpSetProperty{toc-format}{%
      \tpUseProperty{toc-title-face}%
      \tpIfComp{TocNumber}{%
        \@tempdima=\csname tp-heading-toc-number-1-maxwd\endcsname\relax%
        \leftskip\@tempdima\hskip-\@tempdima\hb@xt@\@tempdima{\tpUseComp{TocNumber}\tpUseProperty{toc-number-sep}\hss}%
      }{%\leftskip\z@%
        \tpIfComp{TocAuthorNameList}{\tpTocLink{\tpUseComp{TocAuthorNameList}:}\space}{}%
      }%
      \setbox\@tempboxa=\hbox{\tpUseComp{TocPage}}%
      \advance\rightskip\wd\@tempboxa%
      \tpTocLink{\tpUseComp{TocTitle}}%
      \tpIfComp{TocSubtitle}{%
        \newline%
        {\tpUseProperty{toc-subtitle-face}\tpTocLink{\tpUseComp{TocSubtitle}}}%
      }{}%
      \tpTocLink{\tpUseProperty{toc-page-sep}\rlap{\unhbox\@tempboxa}}%
    }%
  \fi
  \tpSetProperty{before-heading}{\addvspace{24.2bp}}%
  \tpSetProperty{number-sep}{\enskip}%
  \tpSetProperty{title-face}{\sffamily\ifx\ts@layout@type\ts@str@layout@mdw\Large\bfseries\else\LARGE\sbseries\fi}%
  \tpSetProperty{subtitle-face}{\normalfont\sffamily\LARGE}%
  \tpSetProperty{before-quote-skip}{1\baselineskip}%
  \tpSetProperty{quote-block-format}{%
    \vbox{%
      %\justify% Auskommentiert mit Ticket 15122.
      \leftskip0.5\textwidth
      \normalsize\mdseries
      \ifx\ts@layout@type\ts@str@layout@mdw
        \rmfamily%
      \else
        \nsfwiderfamily%
      \fi
      \noindent
      \@tempdima=\baselineskip% Ticket 15122.
      \baselineskip=\dimexpr0.92\@tempdima\relax% Ticket 15122.
      \tpUseComp{QuoteText}\par
      \tpIfComp{QuoteSource}{%
        \itshape\tpUseComp{QuoteSource}%
      }{}%
    }%
  }{}
  \tpSetProperty{heading-block}{%
    \savenotes
    \bgroup
      \normalfont
      \interlinepenalty\@M
      \tpUseProperty{title-face}%
      \tpIfComp{Number}{\tpUseProperty{hang-number}}{\leftskip\z@}%
      \tpUseComp{Title}\par\nopagebreak%
      \tpIfComp{Subtitle}{\tpUseComp{subtitle-face}\tpUseComp{Subtitle}\nopagebreak\par}{}%\addvspace{12.8bp}\nopagebreak}{}% Ticket 14677.
      \tpIfComp{AuthorNameList}{\itshape\tpUseComp{AuthorNameList}\par}{}%
    \egroup
    \nopagebreak
    \tpIfComp{QuoteBlock}{%
      \vskip\tpUseProperty{before-quote-skip}%
      \tpUseComp{QuoteBlock}%
      \par%
    }{}%
    \spewnotes
  }%
  %\tpSetProperty{running-heading}{\tpIfComp{RunNumber}{\tpUseComp{RunNumber}\space}{}\tpUseComp{RunTitle}}%
  \tpSetProperty{bookmark}{%
    \tpIfComp{BMNumber}{%
      \tpUseComp{BMNumber}\enskip%
    }{}%
    \tpUseComp{BMTitle}%
  }
  \tpSetProperty{after-heading-block}{\nopagebreak}
  \tpSetProperty{after-skip}{12.8bp}%
}


\tpDeclareHeading[section]{2}{subsection}{%
  % Ticket 13717.
  \if@backmatter%
    \tpSetProperty{bookmark-level}{1}
    \tpSetProperty{toc-level}{section}
  \fi
  
  \tpSetProperty{before-heading}{\addvspace{11.5bp}}%
  \tpSetProperty{title-face}{\sffamily\ifx\ts@layout@type\ts@str@layout@mdw\sbseries\else\mdseries\fi\Large}%
  \tpSetProperty{before-quote-skip}{.5\baselineskip}%
  \tpSetProperty{running-heading}{}% da subsection sonst die Kolumnentitel ebenfalls von section erben würde
  \tpSetProperty{toc-number-sep}{\enskip}
  \ifcollection
  \else
    \tpSetProperty{toc-indent}{2em}%
    \tpSetProperty{toc-margin-left}{4em}%
    \tpSetProperty{toc-margin-right}{0\p@}%
  \fi
  \ifcollection
    \tpSetProperty{toc-format}{%
      \tpUseProperty{toc-title-face}%
      \@tempdima=\csname tp-heading-toc-number-2-maxwd\endcsname\relax%
      \@tempdimb=\csname tp-heading-toc-number-1-maxwd\endcsname\relax%
      \@tempdimc=\csname tp-heading-toc-number-0-maxwd\endcsname\relax%
      \ifdim\@tempdimb<\@tempdimc\relax
        \@tempdimb=\@tempdimc\relax%
      \fi%
      \tpIfComp{TocNumber}{%
        \tpIfComp{TocAuthorNameList}{\tpTocLink{\tpUseComp{TocAuthorNameList}:}\newline}{}%
        \leftskip\dimexpr\@tempdima+\@tempdimb\relax\hskip-\@tempdima\hbox to \@tempdima{\tpTocLink{\tpUseComp{TocNumber}}\hss}%
      }{%
        \leftskip\@tempdimb%
        \tpIfComp{TocAuthorNameList}{\tpTocLink{\tpUseComp{TocAuthorNameList}:}\space}{}%
      }%
      \noindent%
      %\advance\leftskip by 4em%
      \setbox\@tempboxa=\hbox{\tpUseComp{TocPage}}%
      \rightskip\wd\@tempboxa plus 1fil% 1fil sorgt für Linksbündigkeit des IHV-Eintrags.
      \tpTocLink{\tpUseComp{TocTitle}}%
      \tpIfComp{TocSubtitle}{\newline{\tpUseProperty{toc-subtitle-face}\tpTocLink{\tpUseComp{TocSubtitle}}}}{}%
      \tpTocLink{\tpUseProperty{toc-page-sep}\rlap{\hb@xt@\wd\@tempboxa{\hss\tpUseComp{TocPage}}}}%
    }%
  \else
    \tpSetProperty{toc-before-entry}{%
      \addvspace{\tpUseProperty{toc-margin-top}}
      \parindent \z@
      \raggedright
    }%
    \tpSetProperty{toc-format}{%
      \tpUseProperty{toc-title-face}%
      \@tempdima=\csname tp-heading-toc-number-1-maxwd\endcsname\relax%
      \@tempdimb=\csname tp-heading-toc-number-2-maxwd\endcsname\relax%
      \tpIfComp{TocNumber}{%
        \leftskip\dimexpr\@tempdima+\@tempdimb\relax\hskip-\@tempdimb\hb@xt@\@tempdimb{\tpUseComp{TocNumber}\tpUseProperty{toc-number-sep}\hss}%
      }{%
        \ifdim\@tempdima=0\p@
          \leftskip1em% Ticket 16195.
        \else
          \leftskip\@tempdima%
        \fi
      }%
      \setbox\@tempboxa=\hbox{\tpUseComp{TocPage}}%
      \advance\rightskip\wd\@tempboxa%
      \tpTocLink{\tpUseComp{TocTitle}}%
      \tpIfComp{TocSubtitle}{%
        \newline%
        {\tpUseProperty{toc-subtitle-face}\tpTocLink{\tpUseComp{TocSubtitle}}}%
      }{}%
      \tpTocLink{\tpUseProperty{toc-page-sep}\rlap{\unhbox\@tempboxa}}%
    }%
  \fi
}


\tpDeclareHeading[section]{3}{subsubsection}{%
  \tpSetProperty{before-heading}{%
    \addvspace{1\baselineskip}%
  }%
  %\tpSetProperty{after-skip}{1sp}% Ticket 12534, 2022-04-25
  \tpSetProperty{title-face}{\sffamily\ifx\ts@layout@type\ts@str@layout@mdw\large\itshape\else\Large\mdseries\fi}%
  \ifcollection\else
    %\tpSetProperty{toc-indent}{8em}%
    \tpSetProperty{toc-margin-left}{6.5em}%
  \fi
  \tpSetProperty{toc-format}{%
    \tpIfComp{TocAuthorNameList}{\tpTocLink{\tpUseComp{TocAuthorNameList}:}\newline}{}%
    \tpUseProperty{toc-title-face}%
    \@tempdima=\csname tp-heading-toc-number-3-maxwd\endcsname\relax%
    \@tempdimb=\csname tp-heading-toc-number-1-maxwd\endcsname\relax%
    \@tempdimc=\csname tp-heading-toc-number-0-maxwd\endcsname\relax%
    \ifdim\@tempdimb<\@tempdimc\relax
      \@tempdimb=\@tempdimc\relax%
    \fi%
    \@tempdimc=\csname tp-heading-toc-number-2-maxwd\endcsname\relax%
    \leftskip\dimexpr\@tempdima+\@tempdimb+\@tempdimc\relax%
    \tpIfComp{TocNumber}{%
      \hskip-\@tempdima\hbox to \@tempdima{\tpTocLink{\tpUseComp{TocNumber}}\hss}%
    }{}%
    \tpTocLink{\tpUseComp{TocTitle}}%
    \tpIfComp{TocSubtitle}{\newline{\tpUseProperty{toc-subtitle-face}\tpTocLink{\tpUseComp{TocSubtitle}}}}{}%
    \tpTocLink{\tpUseProperty{toc-page-sep}\tpUseComp{TocPage}}%
  }%
  \tpSetProperty{quote-block-format}{%
    \hfill\hbox{
      \vbox{%
      %\justify% Auskommentiert mit Ticket 15122.
      \leftskip0.5\textwidth
      \normalsize\mdseries
      \ifx\ts@layout@type\ts@str@layout@mdw
        \rmfamily%
      \else
        \nsfwiderfamily%
      \fi
      \noindent
      \@tempdima=\baselineskip% Ticket 15122.
      \baselineskip=\dimexpr0.92\@tempdima\relax% Ticket 15122.
      \tpUseComp{QuoteText}\par
      \tpIfComp{QuoteSource}{%
        \itshape\tpUseComp{QuoteSource}%
      }{}%
      \vskip\baselineskip%
      }%
    }{}
  \tpSetProperty{after-skip}{\z@}%
}

\tpDeclareHeading[section]{4}{paragraph}{%
  \tpSetProperty{before-heading}{\addvspace{12.8bp}}%
  \tpSetProperty{after-skip}{1sp}%
  \tpSetProperty{title-face}{\normalfont\sffamily\normalsize}% 2022-06-02: \sffamily war vorher \sfwidefamily; 12745
}

\tpDeclareHeading{5}{subparagraph}{%
  \tpSetProperty{before-heading}{\addvspace{12.8bp}}%
  \tpSetProperty{after-skip}{-.5em}%
  \tpSetProperty{title-face}{\normalfont\sffamily\normalsize\mdseries}%
}

\endinput
